name: Cleanup Old Caches

on:
  # Run automatically every day at 2 AM UTC to clean up old caches
  schedule:
    - cron: "0 2 * * *" # Every day at 2 AM UTC

  # Also allow manual triggering from GitHub UI
  workflow_dispatch:

jobs:
  cleanup:
    name: Cleanup Old Build Caches
    runs-on: ubuntu-latest
    permissions:
      actions: write

    steps:
      - name: Cleanup caches older than 7 days
        run: |
          echo "ðŸ§¹ Cleaning up caches older than 7 days..."

          # Calculate date 7 days ago
          cutoff_date=$(date -d '7 days ago' -u +%Y-%m-%dT%H:%M:%SZ)
          echo "Cutoff date: $cutoff_date"

          # Get all caches
          echo "Fetching all cache keys..."
          all_caches=$(gh cache list --limit 100 --json id,key,createdAt --jq '.[] | select(.createdAt < "'$cutoff_date'") | .id' 2>/dev/null || echo "")

          if [[ -z "$all_caches" ]]; then
            echo "âœ… No old caches found (older than 7 days)"
            exit 0
          fi

          echo "Found old caches to delete:"
          gh cache list --limit 100 --json id,key,createdAt --jq '.[] | select(.createdAt < "'$cutoff_date'") | "\(.id) - \(.key) (created: \(.createdAt))"' || true

          # Avoid failing the workflow if deletion errors occur
          set +e

          deleted_count=0
          failed_count=0

          echo "Deleting old caches..."
          for cacheId in $all_caches; do
            if gh cache delete "$cacheId"; then
              echo "âœ… Deleted cache: $cacheId"
              ((deleted_count++))
            else
              echo "âŒ Failed to delete cache: $cacheId"
              ((failed_count++))
            fi
          done

          echo "ðŸ§¹ Cache cleanup summary:"
          echo "   - Deleted: $deleted_count old caches"
          echo "   - Failed: $failed_count deletions"
          echo "   - Total processed: $((deleted_count + failed_count)) caches"

          if [[ $failed_count -eq 0 ]]; then
            echo "âœ… All old caches cleaned up successfully"
          else
            echo "âš ï¸  Some cache deletions failed, but this is not critical"
          fi

        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
