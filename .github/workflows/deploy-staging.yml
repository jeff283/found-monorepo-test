name: Deploy to Staging

on:
  # Deploy to staging when code is pushed to staging
  # This includes both direct pushes and merged PRs
  push:
    branches:
      - staging

  # Allow manual triggering from GitHub UI
  workflow_dispatch:

jobs:
  # Build and deploy all apps to staging
  deploy-staging:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    env:
      # Cloudflare configuration
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Clerk authentication (using dev keys for all environments)
      CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY_DEV }}
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY_DEV }}
      CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY_DEV }}

      # Supabase (using dev for now, will switch to prod when ready)
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL_DEV }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY_DEV }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_DEV }}

      # Database (using dev for now)
      DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}

      # Staging API URL
      NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL_STAGING }}

      # Website-specific secrets
      MAILERLITE_API_KEY: ${{ secrets.MAILERLITE_API_KEY }}
      NEXT_PUBLIC_TURNSTILE_SITE_KEY: ${{ secrets.NEXT_PUBLIC_TURNSTILE_SITE_KEY }}
      TURNSTILE_SECRET_KEY: ${{ secrets.TURNSTILE_SECRET_KEY }}
      NEXT_PUBLIC_BASE_URL: ${{ secrets.NEXT_PUBLIC_BASE_URL }}

      # Turborepo caching
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ vars.TURBO_TEAM }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Linting
        run: pnpm run lint

      - name: Run Type Checking
        run: pnpm run check-types

      - name: Build Packages
        run: pnpm run build --filter="./packages/*"

      # Deploy all apps to staging using Turbo
      - name: Deploy All Apps to Staging
        run: |
          echo "üöÄ Deploying all apps to staging using Turbo..."
          pnpm run deploy:stage

      # Notify deployment success
      - name: Staging Deployment Success
        run: |
          echo "‚úÖ Successfully deployed all apps to staging"
          echo "üåê Web App: https://staging.app.foundlyhq.com"
          echo "üåç Website: https://staging.dev.foundlyhq.com"
          echo "‚ö° API: https://staging.api.foundlyhq.com"
          echo "üë• Admin: https://staging.admin.foundlyhq.com"
